<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">

  <title>IIIF Converter</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

</head>

<body>

  <nav class="navbar navbar-dark bg-dark">
    <a class="navbar-brand" href="convert.html">IIIF Converter</a>
  </nav>

  <div class="container mt-5">

    <h3 class="mb-5">Convert IIIF Manifest to Curation</h3>

    <form class="mb-5">

      <div class="input-group">
        <input type="text" class="form-control" id="manifest" name="manifest" placeholder="Manifest URI">
        <div class="input-group-append">
          <button class="btn btn-primary" type="submit">Submit</button>
        </div>
      </div>
    </form>

    <p class="mb-5" id="loading">Processing ... Please check the progress in the console.</p>

    <div class="row" id="row" style="display : none;">
      <div class="col-sm-6">
        <ul class="list-group mb-5">
          <li class="list-group-item list-group-item-secondary" id="li">IIIF Curation</li>
          <li class="list-group-item"><a style="color: #000;" class="iiif-drag-and-drop-link" id="curation"
              target="_blank"><img alt="IIIF Drag-n-drop" src="https://json-ld.org/images/json-ld-data-32.png"
                width="34px">&nbsp;&nbsp;<span>IIIF Curation</span></a>
          </li>
        </ul>
      </div>
      <div class="col-sm-6">
        <ul class="list-group mb-5">
          <li class="list-group-item list-group-item-secondary">Viewer</li>
          <li class="list-group-item"><a style="color: #000;" id="icv" target="_blank"><img
                src="https://iiif.dl.itc.u-tokyo.ac.jp/images/icp.png">&nbsp;&nbsp;<span>ICViwerで閲覧する</span></a>（CODH）
          </li>
          <li class="list-group-item"><a style="color: #000;" id="icp" target="_blank"><img
                src="https://iiif.dl.itc.u-tokyo.ac.jp/images/icp.png">&nbsp;&nbsp;<span>ICPlayerで閲覧する</span></a>（CODH）
          </li>
          <li class="list-group-item"><a style="color: #000;" id="icc" target="_blank"><img
                src="https://iiif.dl.itc.u-tokyo.ac.jp/images/mirador.png">&nbsp;&nbsp;<span>IIIF Curation Comparison
                Toolで閲覧する</span></a>（中村覚作成）</li>
        </ul>
      </div>

    </div>



    <div class="alert alert-danger" role="alert" id="ace" style="display : none;">Request Entity Too Large. Please use
      the following data.</div>

    <div id="editor" style="height: 600px"></div>



    <hr />

    <footer>
      <p>Developed by <a href="https://researchmap.jp/nakamura.satoru/">Satoru Nakamura</a> &amp; <a
          href="https://researchmap.jp/knagasaki/">Kiyonori Nagasaki</a></p>
    </footer>



  </div>

  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"
    integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
    integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.0/ace.js"></script>

  <script>

    function getUrlVars() {
      var vars = {};
      var param = location.search.substring(1).split('&');
      for (var i = 0; i < param.length; i++) {
        var keySearch = param[i].search(/=/);
        var key = '';
        if (keySearch != -1) key = param[i].slice(0, keySearch);
        var val = param[i].slice(param[i].indexOf('=', 0) + 1);
        if (key != '') vars[key] = decodeURI(val);
      }
      return vars;
    }

    function show_result(data) {

      var curation_uri = data["@id"]

      $("#curation").attr("href", curation_uri)
      $("#icv").attr("href", "http://codh.rois.ac.jp/software/iiif-curation-viewer/demo/?curation=" + curation_uri)
      $("#icp").attr("href", "http://codh.rois.ac.jp/software/iiif-curation-player/demo/?curation=" + curation_uri)
      $("#icc").attr("href", "http://diyhistory.org/iiif/search.html?curation=" + curation_uri)

      $("#row").show()
      $("#loading").hide()

    }

    $(document).ready(function () {

      var vars = getUrlVars();

      var manifest = decodeURIComponent(vars.manifest)
      $("#manifest").attr("value", manifest)

      $.ajaxSetup({ async: false });

      var manifest_data = get_data(manifest)

      var canvases = manifest_data.sequences[0].canvases

      var anno_count = 0

      var curation_uri = create({})

      var curation_data = {
        "@context": [
          "http://iiif.io/api/presentation/2/context.json",
          "http://codh.rois.ac.jp/iiif/curation/1/context.json"
        ],
        "@type": "cr:Curation",
        "@id": curation_uri,
        "label": "Automatic curation by IIIF Converter",
        "selections": [
          {
            "@id": curation_uri + "/range1",
            "@type": "sc:Range",
            "label": "Automatic curation by IIIF Converter",
            "members": [],
            "within": {
              "@id": manifest_data["@id"],
              "@type": "sc:Manifest",
              "label": manifest_data.label
            }
          }
        ]
      }

      var test = 0

      for (var i = 0; i < canvases.length; i++) {
        var canvas = canvases[i]
        console.log("canvas " + (i + 1) + "/" + canvases.length)

        if (canvas["otherContent"]) {



          var annolist_data = get_data(canvas["otherContent"][0]["@id"])

          if (!annolist_data) {
            continue
          }

          test += 1

          if (test > 10) {
            //break
          }

          var resources = annolist_data["resources"]
          for (var j = 0; j < resources.length; j++) {
            var resource = resources[j]
            var on = resource.on

            if ($.isArray(on)) {
              on = on[0]["full"] + "#" + on[0]["selector"]["default"]["value"]
            }

            var text = resource.resource.chars

            anno_count += 1

            var member = {
              "@id": on,
              "@type": "sc:Canvas",
              "label": "[Annotation " + anno_count + "]",
              "description": text,
              "metadata": [
                {
                  "label": "Annotation",
                  "value": text
                }
              ]

            }

            curation_data.selections[0].members.push(member)
          }
        }
      }

      console.log(curation_data)

      var result = update(curation_uri, curation_data)

      console.log(curation_uri)

      console.log(result)

      if (result == "error") {

        $("#loading").hide();
        $("#ace").show();

        var editor = ace.edit("editor");
        editor.getSession().setMode("ace/mode/json");
        editor.setTheme("ace/theme/twilight");
        editor.getSession().setTabSize(2);
        editor.getSession().setUseWrapMode(true);
        editor.setValue(JSON.stringify(curation_data, null, '\t'));
      } else {
        show_result(curation_data)
      }

    })

    function get_data(manifest) {
      var data_manifest = null
      $.getJSON(
        manifest,
        function (data) {
          data_manifest = data
        }
      );
      return data_manifest;
    }

    function create(data) {
      var uri = null
      $.ajax({
        url: "https://api.myjson.com/bins",
        type: "POST",
        data: JSON.stringify(data),
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function (result, textStatus, jqXHR) {
          uri = result.uri
        }
      })

      return uri

    }

    function update(uri, data) {
      var result_str = ""
      $.ajax({
        url: uri,
        type: "PUT",
        data: JSON.stringify(data),
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function (result, textStatus, jqXHR) {
          result_str = "success"
        },
        error: function (result, textStatus, jqXHR) {
          result_str = textStatus
        }
      })

      return result_str
    }

  </script>

</body>

</html>