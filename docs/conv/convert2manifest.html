<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">

  <title>IIIF Converter</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

</head>

<body>

  <nav class="navbar navbar-dark bg-dark">
    <a class="navbar-brand" href="convert.html">IIIF Converter</a>
  </nav>

  <div class="container mt-5">

    <h3 class="mb-5">Convert IIIF Curation to Manifest</h3>

    <form class="mb-5">

      <div class="input-group">
        <input type="text" class="form-control" id="curation" name="curation" placeholder="Curation URI">
        <div class="input-group-append">
          <button class="btn btn-primary" type="submit">Submit</button>
        </div>
      </div>
    </form>

    <p class="mb-5" id="loading">Processing ... Please check the progress in the console.</p>

    <div class="row" id="row" style="display : none;">
      <div class="col-sm-6">
        <ul class="list-group mb-5">
          <li class="list-group-item list-group-item-secondary">IIIF Manifest</li>
          <li class="list-group-item" id="li"><a style="color: #000;" class="iiif-drag-and-drop-link" id="collection"
              target="_blank"><img alt="IIIF Drag-n-drop" src="https://iiif.cloud/images/icons-512.png"
                width="34px">&nbsp;&nbsp;<span>IIIF Collection</span></a>
          </li>
        </ul>
      </div>
      <div class="col-sm-6">
        <ul class="list-group mb-5">
          <li class="list-group-item list-group-item-secondary">Viewer</li>
          <li class="list-group-item"><a style="color: #000;" id="mirador" target="_blank"><img
                src="https://iiif.dl.itc.u-tokyo.ac.jp/images/mirador.png">&nbsp;&nbsp;<span>Miradorで注釈を閲覧する</span></a>
          </li>
          <li class="list-group-item"><a style="color: #000;" id="annotator" target="_blank"><img
                src="https://iiif.dl.itc.u-tokyo.ac.jp/images/osd.png">&nbsp;&nbsp;<span>Image AnnotatorでIIIF
                Collectionを閲覧する</span></a></li>
        </ul>
      </div>
    </div>

    <hr />

    <footer>
      <p>Developed by <a href="https://researchmap.jp/nakamura.satoru/">Satoru Nakamura</a> &amp; <a
          href="https://researchmap.jp/knagasaki/">Kiyonori Nagasaki</a></p>
    </footer>



  </div>

  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"
    integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
    integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
    crossorigin="anonymous"></script>

  <script>

    function getUrlVars() {
      var vars = {};
      var param = location.search.substring(1).split('&');
      for (var i = 0; i < param.length; i++) {
        var keySearch = param[i].search(/=/);
        var key = '';
        if (keySearch != -1) key = param[i].slice(0, keySearch);
        var val = param[i].slice(param[i].indexOf('=', 0) + 1);
        if (key != '') vars[key] = decodeURI(val);
      }
      return vars;
    }

    function show_result(data) {

      /*
      var data = {
        "@context": "http://iiif.io/api/presentation/2/context.json",
        "@type": "sc:Collection",
        "vhint": "use-thumb",
        "@id": "https://api.myjson.com/bins/1dkd79",
        "manifests": [
          {
            "@type": "sc:Manifest",
            "@id": "https://api.myjson.com/bins/qcglx",
            "label": "百鬼夜行図",
            "thumbnail": "https://iiif.dl.itc.u-tokyo.ac.jp/iiif/hyakki/images/hyakki.tif/full/200,200/0/default.jpg"
          },
          {
            "@type": "sc:Manifest",
            "@id": "https://api.myjson.com/bins/19ebyt",
            "label": "百鬼夜行図"
          },
          {
            "@type": "sc:Manifest",
            "@id": "https://api.myjson.com/bins/1bu7jp",
            "label": "百鬼夜行絵巻",
            "thumbnail": "https://www.dl.ndl.go.jp/api/iiif/2541003/F0000001/full/full/0/default.jpg"
          }
        ]
      }
      */

      var collection_uri = data["@id"]

      $("#collection").attr("href", collection_uri)

      $("#annotator").attr("href", "http://www.kanzaki.com/works/2016/pub/image-annotator?u=" + collection_uri)

      var manifests_str = ""
      for (var i = 0; i < data.manifests.length; i++) {
        var manifest = data.manifests[i]["@id"]

        var li = $('<li class="list-group-item">')
        $("#li").after(li)

        var a = $('<a style="color: #000;" target="_blank">')
        li.append(a)
        a.attr("href", manifest)

        var img = $("<img src='https://iiif.dl.itc.u-tokyo.ac.jp/images/iiif.png'>")
        a.append(img)
        a.append("&nbsp;&nbsp;" + data.manifests[i].label)


        manifests_str += manifest
        if (i != data.manifests.length - 1) {
          manifests_str += ";"
        }
      }

      $("#mirador").attr("href", "http://da.dl.itc.u-tokyo.ac.jp/mirador/?manifest=" + manifests_str + "&annotationState=on")

      $("#row").show()
      $("#loading").hide()

    }

    $(document).ready(function () {

      //show_result()

      //return;

      var vars = getUrlVars();

      var curation = decodeURIComponent(vars.curation)
      $("#curation").attr("value", curation)

      $.ajaxSetup({ async: false });

      var manifest_map = {}
      var canvas_map = {}

      var curation_data = get_data(curation)

      var selections = curation_data.selections
      for (var i = 0; i < selections.length; i++) {
        var selection = selections[i]
        var manifest = selection.within["@id"]

        if (!manifest_map[manifest]) {
          manifest_map[manifest] = []
        }

        var members = selection.members

        for (var j = 0; j < members.length; j++) {
          var member = members[j]
          var id_member = member["@id"]
          var split_id_member = id_member.split("#")
          var canvas_id = split_id_member[0]

          var canvas_list = manifest_map[manifest]
          if (canvas_list.indexOf(canvas_id) == -1) {
            canvas_list.push(canvas_id)
          }

          var xywh = split_id_member[1]

          if (!canvas_map[canvas_id]) {
            canvas_map[canvas_id] = []
          }

          canvas_map[canvas_id].push({
            "metadata": member.metadata,
            "xywh": xywh
          })

        }

      }

      console.log(manifest_map)

      var collection_uri = create({})
      var collection = {
        "@context": "http://iiif.io/api/presentation/2/context.json",
        "label": curation.label,
        "@type": "sc:Collection",
        "vhint": "use-thumb",
        "@id": collection_uri,
        "manifests": []
      }

      for (var manifest in manifest_map) {

        console.log(manifest)

        if (manifest.indexOf("http://") != -1) {
          manifest = manifest.replace("http://", "https://")
        }

        var data_manifest = get_data(manifest)

        if (data_manifest == null) {
          console.log("Error: " + manifest)
          continue
        }

        var new_manifest = create({})

        var canvas_list = manifest_map[manifest]
        for (var i = 0; i < canvas_list.length; i++) {
          var canvas_id = canvas_list[i]
          var curation_list = canvas_map[canvas_id]

          var annolist_id = create({})

          var annolist = {
            "@context": "http://iiif.io/api/presentation/2/context.json",
            "@id": annolist_id,
            "@type": "sc:AnnotationList",
            "resources": []
          }

          for (var j = 0; j < curation_list.length; j++) {
            var curation = curation_list[j]
            var text = JSON.stringify(curation.metadata)
            if (text == null) {
              text = "Curation [" + (j + 1) + "]"
            }
            var xywh = curation.xywh
            var anno_id = annolist_id + "#" + j

            var anno = {
              "@id": anno_id,
              "@type": "oa:Annotation",
              "motivation": "sc:painting",
              "resource": {
                "@type": "cnt:ContentAsText",
                "chars": text,
                "format": "text/plain"
              },
              "on": canvas_id + "#" + xywh
            }

            annolist.resources.push(anno)

          }

          update(annolist_id, annolist)

          data_manifest = set_otherContent(data_manifest, canvas_id, annolist_id)

        }

        data_manifest["@id"] = new_manifest
        update(new_manifest, data_manifest)

        var obj = {
          "@type": "sc:Manifest",
          "@id": new_manifest,
          "label": data_manifest.label
        }

        if (data_manifest.sequences[0].canvases[0].thumbnail) {
          obj.thumbnail = data_manifest.sequences[0].canvases[0].thumbnail["@id"]
        }

        collection.manifests.push(obj)


      } // end for manifest

      update(collection_uri, collection)

      console.log(collection_uri)

      show_result(collection)
    })

    function set_otherContent(data_manifest, canvas_id, annolist_id) {
      var canvases = data_manifest.sequences[0].canvases
      for (var i = 0; i < canvases.length; i++) {
        var canvas = canvases[i]
        if (canvas["@id"] == canvas_id) {
          canvas.otherContent = [{
            "@id": annolist_id,
            "@type": "sc:AnnotationList"
          }]
        }
      }
      return data_manifest
    }

    function get_data(manifest) {
      var data_manifest = null
      $.getJSON(
        manifest,
        function (data) {
          data_manifest = data
        }
      );
      return data_manifest;
    }

    function create(data) {
      var uri = null
      $.ajax({
        url: "https://api.myjson.com/bins",
        type: "POST",
        data: JSON.stringify(data),
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function (result, textStatus, jqXHR) {
          uri = result.uri
        }
      })

      return uri

    }

    function update(uri, data) {
      $.ajax({
        url: uri,
        type: "PUT",
        data: JSON.stringify(data),
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function (result, textStatus, jqXHR) {
        }
      })
    }

  </script>

</body>

</html>